{"version":3,"sources":["../../src/models/coinmarketcap.js"],"names":["mysql","require","connection","createConnection","host","user","password","port","database","module","exports","addListLatest","rData","cb","resData","data","collection","obj","timestamp","status","timestamp_new","date","UTC8ymd","ymd","find","p","Promise","resolve","reject","dbhelper","mas","err","mid","console","log","insert","addSql_value_arr","count","i","last_updated_new","last_updated","last_updated_main","usd_last_updated_new","quote","USD","last_updated_usd","btc_last_updated_new","last_updated_btc","usd_volume_24h","parseInt","volume_24h","cny_volume_24h","usd_market_cap","market_cap","cny_market_cap","turnover","toFixed","price","cnyPrice","usd_percent_change_1h","percent_change_1h","usd_percent_change_24h","percent_change_24h","usd_percent_change_7d","percent_change_7d","addSql_value","id","name","symbol","slug","circulating_supply","total_supply","max_supply","change_1h","push","e","addSql_value_str","toString","addSql","query","result","msg","update","whereObj","deleteMany","then","type"],"mappings":"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","file":"coinmarketcap.js","sourcesContent":["import db from '../db';\nimport dbhelper from './dbhelper';\nimport date from '../lib/date';\n\nvar mysql  = require('mysql'); \n\nvar connection = mysql.createConnection({    \n\n  host     : '127.0.0.1',      \n\n  user     : 'root',             \n\n  password : '123456',      \n\n  port: '3306',                  \n\n  database: 'im_k_data',\n\n});\n\nmodule.exports.addListLatest=function(rData,cb){\n\n\tvar resData = rData.data;\n\tvar collection = 'coinmarketcap_listings_latest';//查表\n\tvar obj={'whereObj':'max(id) as mid'};//查询条件\n\tvar timestamp = rData.status.timestamp;\n\tvar timestamp_new = date.UTC8ymd(timestamp);\n\t\ttimestamp = date.ymd(timestamp_new);//状态的时间戳\n\t\n\n\t//对比数据库数据和coinmarketcap数据 \n\tfunction find(){\n\n\t\tvar p = new Promise(function(resolve, reject){\n\t\t\tdbhelper.find(collection,obj,function(mas,err){//查询数据库最新的一条数据\n\n\t\t\t\tif(!err){\n\n\t\t\t\t\tif (mas[0].mid === null) {//数据库为空\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar data = {'type':'insert'};\n\t\t\t\t\t\tresolve(data);//插入\n\t\t\t\t\t}else{//数据不为空\n\n\t\t\t\t\t\tvar data = {'type':'update'};\n\t\t\t\t\t\tresolve(data);//更新\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tconsole.log(\"err...\",err);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\treturn p ;\n\t}\n\n\t//插入\n\t//市值 价格 换手率 24h成交量(USD) 24H涨跌幅 24H涨跌幅 7D涨跌幅\n\tfunction insert(){\n\n\t\tvar addSql_value_arr = [];\n\n\t\ttry{\n\t\t\tvar count = -1;\n\t\t\tfor(var i in resData){//遍历最新数据\n\n\t\t\t\tcount ++;\n\t\t\t\tif (count == 200) { break ;}//限制条数\n\t\t\t\t\n\t\t\t\tvar last_updated_new = date.UTC8ymd(resData[count].last_updated);\n\t\t\t\tvar last_updated_main = date.ymd(last_updated_new);//货币对主体更新时间 - 转换成东八区\n\t\t\t\tvar usd_last_updated_new = date.UTC8ymd(resData[count].quote.USD.last_updated);\n\t\t\t\tvar last_updated_usd = date.ymd(usd_last_updated_new);//usd的更新时间 - 转换成东八区\n\t\t\t\tvar btc_last_updated_new = date.UTC8ymd(resData[count].quote.USD.last_updated);\n\t\t\t\tvar last_updated_btc = date.ymd(btc_last_updated_new);//btc的更新时间 - 转换成东八区\n\n\t\t\t\tvar usd_volume_24h = parseInt(resData[count].quote.USD.volume_24h);//24交易额\n\t\t\t\tvar cny_volume_24h = parseInt(resData[count].quote.USD.volume_24h*7);//24交易额\n\t\t\t\tvar usd_market_cap = parseInt(resData[count].quote.USD.market_cap);//总市值\n\t\t\t\tvar cny_market_cap = parseInt(resData[count].quote.USD.market_cap*7);//总市值\n\t\t\t \tvar turnover = (usd_volume_24h/usd_market_cap)*100;//换手率\n\t\t\t \t \tturnover = turnover.toFixed(2);//保留小数点后2位\n\t\t\t \t\tusd_market_cap = (usd_market_cap/100000000).toFixed(2);//亿美元 市值 保留小数点后2位\n\t\t\t \t\tusd_volume_24h = (usd_volume_24h/100000000).toFixed(2);//亿美元 24交易额 保留小数点后2位\n\n\t\t\t \tvar price = (resData[count].quote.USD.price).toFixed(4);//price 保留小数点后4位\n\t\t\t \tvar cnyPrice = (resData[count].quote.USD.price*7).toFixed(2);//price 保留小数点后4位\n\n\t\t\t \tvar usd_percent_change_1h = (resData[count].quote.USD.percent_change_1h).toFixed(2);;//1h\n\t\t\t \tvar usd_percent_change_24h = (resData[count].quote.USD.percent_change_24h).toFixed(2);;//24h\n\t\t\t \tvar usd_percent_change_7d = (resData[count].quote.USD.percent_change_7d).toFixed(2);;//7d\n\t\t\t \t\n\t\t\t\tvar addSql_value = '('+resData[count].id+',\"'+resData[count].name+'\",\"'+resData[count].symbol+'\",\"'+resData[count].slug+'\",\"'+turnover+'\",\"'+resData[count].circulating_supply+'\",\"'+resData[count].total_supply+'\",\"'+resData[count].max_supply+'\",\"'+last_updated_main+'\",\"'+price+'\",\"'+usd_volume_24h+'\",\"'+usd_percent_change_1h+'\",\"'+usd_percent_change_24h+'\",\"'+usd_percent_change_7d+'\",\"'+usd_market_cap+'\",\"'+last_updated_usd+'\",\"'+resData[count].quote.USD.price+'\",\"'+resData[count].quote.USD.change_1h+'\",\"'+resData[count].quote.USD.percent_change_24h+'\",\"'+resData[count].quote.USD.percent_change_7d+'\",\"'+resData[count].quote.USD.market_cap+'\",\"'+last_updated_btc+'\",\"'+timestamp\n\t\t\t\t+'\")';//拼接获取的数据\n\t\t\t\taddSql_value_arr.push(addSql_value);//遍历出来的数据添加到数组\n\t\t\t\t\n\t\t\t}\n\t\t\t// resData.map((val,index)=>{//遍历最新数据\n\n\t\t\t// \t\tvar last_updated_new = date.UTC8ymd(val.last_updated);\n\t\t\t// \t\tvar last_updated_main = date.ymd(last_updated_new);//货币对主体更新时间 - 转换成东八区\n\n\t\t\t// \t\tvar usd_last_updated_new = date.UTC8ymd(val.quote.USD.last_updated);\n\t\t\t// \t\tvar last_updated_usd = date.ymd(usd_last_updated_new);//usd的更新时间 - 转换成东八区\n\n\t\t\t// \t\tvar btc_last_updated_new = date.UTC8ymd(val.quote.USD.last_updated);\n\t\t\t// \t\tvar last_updated_btc = date.ymd(btc_last_updated_new);//btc的更新时间 - 转换成东八区\n\n\t\t\t// \t\tvar addSql_value = '('+val.id+',\"'+val.name+'\",\"'+val.symbol+'\",\"'+val.slug+'\",\"'+val.circulating_supply+'\",\"'+val.total_supply+'\",\"'+val.max_supply+'\",\"'+last_updated_main+'\",\"'+val.quote.USD.price+'\",\"'+val.quote.USD.volume_24h+'\",\"'+val.quote.USD.percent_change_1h+'\",\"'+val.quote.USD.percent_change_24h+'\",\"'+val.quote.USD.percent_change_7d+'\",\"'+val.quote.USD.market_cap+'\",\"'+last_updated_usd+'\",\"'+val.quote.USD.price+'\",\"'+val.quote.USD.change_1h+'\",\"'+val.quote.USD.percent_change_24h+'\",\"'+val.quote.USD.percent_change_7d+'\",\"'+val.quote.USD.market_cap+'\",\"'+last_updated_btc+'\",\"'+timestamp\n\t\t\t// \t\t+'\")';//拼接获取的数据\n\t\t\t// \t\taddSql_value_arr.push(addSql_value);//遍历出来的数据添加到数组\n\t\t\t// })\n\t\t}catch(e){\n\t\t\tconsole.log(\"catch\",e);\n\t\t}\n\t\tvar addSql_value_str = addSql_value_arr.toString();//数组转字符串 继续执行拼接后的values\n\n\t\t//id(标示)name(名字) symbol(交易对)slug(全称)circulating_supply(当前供应量) total_supply(总供应量) max_supply(最大供应量) last_updated(更新时间) usd_price(美元价格) usd_volume_24h(美元24小时成交量),usd_percent_change_1h(美元报价1小时涨跌幅) usd_percent_change_24h(美元报价24小时涨跌幅) usd_percent_change_7d(美元报价7天涨跌幅)  usd_market_cap(美元报价交易量), usd_last_updated (美元报价数据更新时间), btc_price(btc报价的价格), btc_change_1h(btc统计的1h成交量),btc_percent_change_24h(btc报价的24小时涨跌幅),btc_percent_change_7d(btc报价的7天涨跌幅),btc_market_cap(btc报价统计的成交量),btc_last_updated(btc报价的统计时间),status_timestamp\n\t\tvar addSql = 'INSERT INTO '+collection+'(id,name,symbol,slug,turnover,circulating_supply,total_supply,max_supply,last_updated,usd_price,usd_volume_24h,usd_percent_change_1h,usd_percent_change_24h,usd_percent_change_7d,usd_market_cap,usd_last_updated,btc_price,btc_change_1h,btc_percent_change_24h,btc_percent_change_7d,btc_market_cap,btc_last_updated,status_timestamp) VALUES'+addSql_value_str+';'\n\t\t\t//插入\n\t\t\tconnection.query(addSql,function (err, result) {\n\n\t\t        if(err){\n\t\t        \tconsole.log('[INSERT ERROR] - ',err);\n\t\t        \treturn ;\n\t\t        }else{\n\t\t        \t//>>>insert\n\t\t        \tconsole.log('>>>>>>>>insert addSql Success');  \n\t\t\t\t\tvar msg={insert:result};\n\t\t\t\t\tcb(msg);\n\t\t        }\t\t\t    \n\t\t\t});\t\t\t\t\t\t\t\n\t\t}\n\t\t//更新\n\tfunction update(){\n\n\t\tvar obj = {whereObj:'id>0'};\t\t\n\t\tdbhelper.deleteMany(collection,obj,function(err,result){\n\t\t\tif (!err) {\n\t\t\t\tif (result) {insert()}//清空后插入\n\t\t\t}else{\n\t\t\t\tconsole.log(err);\n\t\t\t}\n\t\t})\n\t\treturn ;//！！！\n\t}\n\n\t//>>>执行\n\tfind()\n\t.then(function(data){\n\t\tif (data.type === 'insert') {return insert();}\n\t\tif (data.type ==='update') {return update();}\n\t})\n}\n\n\n\n\n\n\n\n\n\n\n\n\n"]}